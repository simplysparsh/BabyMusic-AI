# Udio API Integration via PiAPI.ai

This document outlines the integration between Baby Music AI and the Udio music generation API, facilitated through the PiAPI.ai proxy service.

## Endpoints Used

### 1. Create Generation Task (`/api/v1/creation/sync/prompt`)

- **Description**: This endpoint initiates a music generation task based on a textual prompt.
- **Mode**: Description Mode (Similar to Udio's standard prompt-based generation)
- **Reference**: [PiAPI Udio Prompt Endpoint](https://piapi.ai/udio-api#operation/prompt)

### 2. Get Task Status/Result (`/api/v1/task/{taskId}`)

- **Description**: Retrieves the status and output (including audio URLs) of a specific generation task initiated via PiAPI.
- **Reference**: [PiAPI Get Task Endpoint](https://piapi.ai/udio-api#operation/get_task)

## Workflow

1.  **User Request**: User initiates song generation (preset or custom) via the Baby Music AI frontend.
2.  **Backend Call**: The frontend calls a Supabase Edge Function (`/api/songs` - hypothetical).
3.  **Lyric Generation (Optional)**: If needed, the Edge Function calls Claude API to generate lyrics.
4.  **PiAPI Task Creation**: The Edge Function constructs the request payload for PiAPI's Udio `/sync/prompt` endpoint, including lyrics, mood, theme, etc.
5.  **Task ID Received**: PiAPI returns a `taskId` for the generation task.
6.  **Store Task ID**: The Edge Function updates the corresponding `songs` record in the Supabase database with the `taskId`.
7.  **Webhook Notification**: When Udio finishes generating the song via PiAPI, PiAPI sends a webhook notification to Baby Music AI's configured endpoint (`/api/piapi-webhook` - handled by `supabase/functions/piapi-webhook`).
8.  **Webhook Processing**: The webhook function (`piapi-webhook`):
    *   Authenticates the request (using `VITE_WEBHOOK_SECRET`).
    *   Parses the payload containing the `taskId`, `status`, and `output` (including audio URLs).
    *   Finds the corresponding `songs` record using the `taskId`.
    *   Updates the `songs` record with the `audio_url` (and potentially lyrics if generated by Udio) and clears the `taskId`.
    *   Handles potential variations if multiple audio outputs are provided.
    *   Logs errors to `lyric_generation_errors` or updates the song record with an error state if generation failed.
9.  **Frontend Update**: Supabase Realtime subscriptions notify the frontend (`songStore`) of the change to the `songs` record. The UI updates to show the song as ready or failed.

## API Request/Response Examples (Simplified)

### Create Task Request (`POST /api/v1/creation/sync/prompt`)

```json
{
  "model": "udio",
  "version": "v1.5",
  "payload": {
    "prompt": "A gentle, calming lullaby for baby {babyName} with soft female vocals, featuring piano and strings.",
    "mood": "calm",
    "theme": "sleepRegulation", 
    "is_instrumental": false,
    "voice_type": "softFemale",
    "tempo": "slow"
    // Other relevant parameters like custom lyrics can be added here
  },
  "webhook_endpoint": "https://your-app.netlify.app/api/piapi-webhook",
  "webhook_secret": "{your_webhook_secret}"
}
```

### Create Task Response

```json
{
  "success": true,
  "task_id": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

### Get Task Response (`GET /api/v1/task/{taskId}`)

> This endpoint retrieves the output of a Song generation task.

```json
{
  "task_id": "xxxx",
  "status": "completed", // or "processing", "failed"
  "output": {
    "songs": [
      {
        "id": "udio-song-id-1",
        "song_path": "https://audio-url-1.mp3",
        "title": "Generated Song Title 1",
        "lyrics": "Generated lyrics...",
        "image_path": "https://image-url-1.png",
        "duration": 123.45
      },
      {
        "id": "udio-variation-id-1", // Variation ID
        "song_path": "https://audio-url-variation-1.mp3", // Variation audio
        "title": "Generated Song Title 1 (Variation)",
        "lyrics": "Generated lyrics...", 
        "image_path": "https://image-url-variation-1.png",
        "duration": 125.67
      }
    ]
  },
  "error": null // or error details if failed
}
```

### Webhook Payload (`POST /api/piapi-webhook`)

(Payload structure is often similar to the Get Task Response)

```json
{
  "data": {
    "task_id": "xxxx",
    "status": "completed",
    "output": {
      "songs": [
        {
          "id": "udio-song-id-1",
          "song_path": "https://audio-url-1.mp3",
          // ... other song details
        },
        {
          "id": "udio-variation-id-1",
          "song_path": "https://audio-url-variation-1.mp3",
          // ... other variation details
        }
      ]
    },
    "error": null
  }
}
```

## Key Implementation Files

-   `src/lib/piapi.ts`: Contains functions to interact with the PiAPI endpoints (`createMusicGenerationTask`).
-   `supabase/functions/piapi-webhook/index.ts`: Handles incoming webhook notifications from PiAPI.
-   `src/store/songStore.ts`: Manages song state and interacts with generation services.

## Authentication

-   **PiAPI Key**: Stored securely as an environment variable (`VITE_PIAPI_KEY`). Used in backend requests to PiAPI.
-   **Webhook Secret**: Stored securely (`VITE_WEBHOOK_SECRET`). Used to authenticate incoming webhooks.

## Error Handling

-   Timeouts are implemented for API calls.
-   Errors from PiAPI/Udio are caught and logged.
-   Webhook handler includes robust error checking and validation.
-   Failed song generations update the song record with an error message and `retryable` flag.

## PIAPI Field Character Limits

Based on extensive testing, here are the character limits for various fields when sending requests to the PIAPI music generation service:

### Field Limits Summary

| Field | Character Limit | Status |
|-------|-----------------|--------|
| `prompt` (lyrics) | 1000 characters | ✅ Confirmed |
| `negative_tags` | 100 characters | ✅ Confirmed |
| `gpt_description_prompt` | No limit up to 10,000 chars | ✅ Tested |
| `title` | No clear limit (at least 300 chars) | ✅ Tested |

### Details of Testing

#### `prompt` (lyrics)
- **Limit**: Exactly 1000 characters
- **Behavior**: 
  - 1000 characters: Accepted
  - 1001 characters: Error - "lyrics cannot exceed 1000 characters, got 1001"
- **Implementation**: The System prompt in Claude API instructs 1000 character limit, and code truncates to 1000 characters

#### `negative_tags`
- **Limit**: Exactly 100 characters
- **Behavior**: 
  - 100 characters: Accepted
  - 101 characters: Error - "negative tags cannot exceed 100 characters, got 101"
- **Implementation**: Truncated to 100 characters in code

#### `gpt_description_prompt`
- **No enforced limit** detected up to 10,000 characters
- Successfully tested with: 100, 200, 250, 300, 500, 1000, 1500, 2000, 3000, 5000, 8000, 10000 characters
- **Implementation**: Code allows large descriptions (up to 10,000 chars)

#### `title`
- **No clear limit** detected up to at least 300 characters
- Successfully tested with: 50, 100, 200, 300 characters
- Inconclusive tests at larger sizes due to concurrent task limitations

## Notes

-   The `song_type` field in the `songs` table helps differentiate between preset songs, theme-based songs, and fully custom songs.
-   Variations are stored in the `song_variations` table, linked to the main song via `song_id`.

---
*Old Notes (May contain outdated info)*

-   PiAPI might act as a proxy for multiple underlying models (like Udio, potentially others mentioned historically like Suno). Ensure requests specify the correct model (`udio`).
-   The specific format of `output.songs` (especially variation handling) should be confirmed with current PiAPI documentation for Udio.
